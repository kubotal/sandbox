sources:
  - name: podinfo
    kind: HelmRepository
    template: helmRepository
    config:
      url: https://stefanprodan.github.io/podinfo

components:
  - name: podinfo
    createNamespace: true
    vars:
      allowedUsers: []
      allowedGroups: []
      allowedEmails: []
      dex:
        connector: skas
      ingress: podinfo
    modules:
      - name: main
        source: podinfo
        chart:
          name: podinfo
          version: 6.5.4
        values: |
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - "ALL"
            runAsNonRoot: true
            seccompProfile:
              type: RuntimeDefault
            runAsUser: 100 # User 'app'
          ingress:
            enabled: false
      - name: dex
        source: flux-system
        chart:
          path: ./charts/dex/2.36.0
        values: |
          nameOverride: {{ .Meta.deployment.name }}-dex
          logger:
            level: debug
          ingress:
            host: dex.{{ .Vars.ingress }}.{{ .Context.ingress.url }}
            clusterIssuer: {{ .Context.certificateIssuer.public  }}
          firstStaticClient:
            name: "podinfo"
            id: "{{ .Meta.deployment.name }}-dg"
            redirectURIs:
              - https://{{ .Vars.ingress }}.{{ .Context.ingress.url }}/dg_callback
          connectors:
            {{- toYaml (get .Context.dex.connectors .Vars.dex.connector)  | nindent 12 }}
      - name: dexgate
        source: flux-system
        chart:
          path: ./charts/dexgate/0.1.2
        values: |
          nameOverride: {{ .Meta.deployment.name }}-dexgate
          proxy:
            targetURL: http://{{ .Meta.deployment.name }}-main:9898
          ingress:
            host: {{ .Vars.ingress }}.{{ .Context.ingress.url }}
            clusterIssuer: {{ .Context.certificateIssuer.public  }}
          oidc:
            clientID:
              secret:  
                name: {{ .Meta.deployment.name }}-dg-client-secret
                key: clientId              
            clientSecret:
              secret:  
                name: {{ .Meta.deployment.name }}-dg-client-secret
                key: clientSecret              
            issuerURL: https://dex.{{ .Vars.ingress }}.{{ .Context.ingress.url }}/dex
            ca:
              crt: {{ .Context.publicCA }}
          users:
            allowedUsers: {{ .Vars.allowedUsers }}
            allowedGroups: {{ .Vars.allowedGroups }}
            allowedEmails: {{ .Vars.allowedEmails }}
