
sources:

  - name: flux-system
    create: false
    kind: GitRepository

  - name: stakater
    kind: HelmRepository
    template: helmRepository
    config:
      url: https://stakater.github.io/stakater-charts

  - name: mittwald
    kind: HelmRepository
    template: helmRepository
    config:
      url: https://helm.mittwald.de

  - name: jetstack
    kind: HelmRepository
    template: helmRepository
    config:
      url: https://charts.jetstack.io

  - name: metallb
    kind: HelmRepository
    template: helmRepository
    config:
      url: https://metallb.github.io/metallb

  - name: ingress-nginx
    kind: HelmRepository
    template: helmRepository
    config:
      url: https://kubernetes.github.io/ingress-nginx

  - name: skas
    kind: HelmRepository
    template: helmRepository
    config:
      url: https://skasproject.github.io/skas-charts


components:

  - name: replicator
    createNamespace: true
    modules:
      - name: main
        source: mittwald
        chart:
          name: kubernetes-replicator
          version: 2.9.2
        values:
          podSecurityContext:
            seccompProfile:
              type: RuntimeDefault
          securityContext:  # For container
            capabilities:
              drop:
                - ALL
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
          livenessProbe:
            initialDelaySeconds: 10 # Was 60
            #  periodSeconds: 10
            #  timeoutSeconds: 1
            #  failureThreshold: 3
            #  successThreshold: 1
          readinessProbe:
            initialDelaySeconds: 10 # Was 60
            #  periodSeconds: 10
            #  timeoutSeconds: 1
            #  failureThreshold: 3
            #  successThreshold: 1

  - name: secret-generator
    createNamespace: true
    modules:
      - name: main
        source: mittwald
        chart:
          name: kubernetes-secret-generator
          version: 3.4.0
        values:
          # Otherwise, we got secret-generator-secret-generator
          fullnameOverride: secret-generator
          podSecurityContext:
            fsGroup: 2000
            seccompProfile:
              type: RuntimeDefault  # ?
          securityContext:
            allowPrivilegeEscalation: false   # ?
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000

  - name: reloader
    createNamespace: true
    modules:
      - name: main
        config:
          timeout: 3m
        source: stakater
        chart:
          name: reloader
          version: 1.0.72
        values:
          reloader:
            deployment:
              securityContext:
                seccompProfile:
                  type: RuntimeDefault
              containerSecurityContext:
                capabilities:
                  drop:
                    - ALL
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true

  - name: cert-manager
    createNamespace: true
    vars:
      trustNamespace: cert-manager
    modules:
      - name: main
        source: jetstack
        chart:
          name: cert-manager
          version: v1.14.4
        values:
          installCRDs: true
      - name: trust
        source: jetstack
        template: helmRelease
        chart:
          name: trust-manager
          version: v0.9.2
        values: |
          app:
            trust:
              namespace: {{ .Vars.trustNamespace }}
          secretTargets:
            enabled: false
        dependsOn:
          - main
      - name: issuers
        source: flux-system
        chart:
          path: charts/cert-issuers/0.1.0
        config:
          install:
            remediation:
              retries: 10
        values: |
          {{ toYaml .Context.certIssuers }}
        dependsOn:
          - main
          - trust

  - name: metallb
    createNamespace: true
    modules:
      - name: main
        source: metallb
        chart:
          name: metallb
          version: 0.14.4
      - name: pool
        source: flux-system
        chart:
          path: ./charts/metallb-pool/0.1.0
        values: |
          ipRanges:
            - first: {{ resolveDNS (printf "first.pool.%s" .Context.cluster.domain) }}
              last: {{ resolveDNS (printf "last.pool.%s" .Context.cluster.domain) }}
        dependsOn:
          - main

  - name: ingress-nginx
    createNamespace: true
    modules:
      - name: main
        source: ingress-nginx
        chart:
          name: ingress-nginx
          version: 4.10.0
        values: |
          controller:
            service:
              annotations:
                metallb.universe.tf/loadBalancerIPs: {{ resolveDNS .Context.ingress.url }}
                metallb.universe.tf/allow-shared-ip: "ingress"
            extraArgs:
              enable-ssl-passthrough: true
              
  - name: skas
    createNamespace: true
    modules:
      - name: main
        config:
          timeout:  "5m"
        source: skas
        chart:
          name: skas
          version: 0.2.2-snapshot
        values: |
          clusterIssuer: {{ .Context.certificateIssuer.public }}
          image:
            tag: 0.2.2-snapshot
            pullPolicy: Always
          skMerge:
            providers:
              - name: crd
              - name: ldap
          skAuth:
            exposure:
              external:
                ingress:
                  host: skas.{{ .Context.ingress.url }}
            kubeconfig:
              context:
                name: skas@{{ .Context.cluster.name }}
              cluster:
                {{- if .Context.apiServer }}
                apiServerUrl: https://127.0.0.1:{{ .Context.apiServer.portOnLocalhost }}
                {{- else }}
                apiServerUrl: https://kubernetes.{{ .Context.ingress.url }}
                {{- end }}
            passwordStrength:
              forbidCommon: false    # Test against lists of common password
              minimumScore: 0       # From 0 (Accept anything) to 4
          skHConf:
            enabled: true
            image:
              tag: 0.2.2-snapshot
              pullPolicy: Always
          skPadl:
            enabled: true
            log:
              mode: dev
              level: trace
            ldap:
              bindPassword: mysecret
            exposure:
              ssl: true
              loadBalancer:
                enabled: true
                {{ $padl := printf "padl.%s" .Context.cluster.domain }}
                ip: {{ resolveDNS $padl }}
                hosts:
                  - {{ $padl }}
          skLdap:
            enabled: true
            ldap:
              host: openldap-main.openldap.svc
              timeoutSec: 10
              insecureNoSSL: false
              bindDN: cn=admin,dc=odp,dc=com
              bindPW: admin123
              rootCaData: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUdTekNDQkRPZ0F3SUJBZ0lKQU4zclBySE5JRmZBTUEwR0NTcUdTSWIzRFFFQkN3VUFNSFV4Q3pBSkJnTlYKQkFZVEFrWlNNUTR3REFZRFZRUUlEQVZRWVhKcGN6RU9NQXdHQTFVRUJ3d0ZVR0Z5YVhNeEdUQVhCZ05WQkFvTQpFRTl3Wlc1RVlYUmhVR3hoZEdadmNtMHhGakFVQmdOVkJBc01EVWxVSUVSbGNHRnlkRzFsYm5ReEV6QVJCZ05WCkJBTU1DbU5oTG05a2NDNWpiMjB3SGhjTk1qRXdPREU0TURreU16QTFXaGNOTXpFd09ERTJNRGt5TXpBMVdqQjEKTVFzd0NRWURWUVFHRXdKR1VqRU9NQXdHQTFVRUNBd0ZVR0Z5YVhNeERqQU1CZ05WQkFjTUJWQmhjbWx6TVJrdwpGd1lEVlFRS0RCQlBjR1Z1UkdGMFlWQnNZWFJtYjNKdE1SWXdGQVlEVlFRTERBMUpWQ0JFWlhCaGNuUnRaVzUwCk1STXdFUVlEVlFRRERBcGpZUzV2WkhBdVkyOXRNSUlDSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQWc4QU1JSUMKQ2dLQ0FnRUE2cFBqejVCb1FYczZ2NE02NHBwc1JvTEFBeHMxQmovRmJGZTBzVzIycG9XL1d0L1NHSWVVVTdCUgpmZUhJOUdNbE53WmlkSXV0ZEU5d0N1a2pIbVVLbVhmRUx4MXlhamdTSm5PSmR1cWdCZHBHNTVwLzhtQ2lubVk2Cm1Pdis2V0hGMHFIYjVEZjZTTHhpSFNkTEZQVWtwV3IrbmI2T0JxaERsZ2JNUjA5WVZwV1ZHTlFqalQvSWdhbmIKRG12S1Z2S0VXTEk2cGZGVDhxWW5rTnNxamQ3T1NiZGdaVlRPTGh4YVJIZ2xVUlc3dGNvaXIyYW8rWFRNSkJaVAo4elRmS1BOVmcwK3c5ODBmVVY0dCtSZElFdXREbTdFa1JCcXBXNkZtZktFOFlhb2thWHJxMjgrVUFWSFpMd1BxCk1jVnFTeVNzaVR0bTBSYXhjcG9aYUQ5SjdWWlB1UGxlOUluUE1sNTJYaE1pZHBlNG9SYW1JRjJlUnNOZExkVTYKQklPcTBtNHRaTkk1QnRwbXBTZVlMOXBBMmtGL3UwT2Z1VWNUbVZTSlBGMkMybVJETVpmMVMxVFVGYnVIK1N2ZgoraTQ4bFVoSjIvajlURVkxRk1DM0oxMkVBUXk0YXpBa0FXWkdKUDBBdzBpdFBjUkJVMkJ0ZXV1VWhhQlNWTU9JCkxxSGFhTXRhZzJCUXcwblBhTDhabFNRcVJyakF0NnRaUDhqTnNpRFBxSE9SOVFDb29EbGZoWUJ5T3l2Ry9FWHEKWXpVUUV3NXF2NkdiSzJLYWs5U0s0ckhqRGF6V1l3a0Mza1grbkxiREFmcUNMNkhpWUMyL0ZiQzVwVmlyM0o5RwppM0JIVFBTRk9rQ2t3QkJMNGE4ZWxDRWRmajEvTlRxNDYzNzRiQU1jSHcvV2dqdzhCT0VDQXdFQUFhT0IzVENCCjJqQVBCZ05WSFJNQkFmOEVCVEFEQVFIL01CMEdBMVVkRGdRV0JCUk90dmNMS0E4UFhOUGs1bmRFL0Y5SldKb3gKbWpDQnB3WURWUjBqQklHZk1JR2NnQlJPdHZjTEtBOFBYTlBrNW5kRS9GOUpXSm94bXFGNXBIY3dkVEVMTUFrRwpBMVVFQmhNQ1JsSXhEakFNQmdOVkJBZ01CVkJoY21sek1RNHdEQVlEVlFRSERBVlFZWEpwY3pFWk1CY0dBMVVFCkNnd1FUM0JsYmtSaGRHRlFiR0YwWm05eWJURVdNQlFHQTFVRUN3d05TVlFnUkdWd1lYSjBiV1Z1ZERFVE1CRUcKQTFVRUF3d0tZMkV1YjJSd0xtTnZiWUlKQU4zclBySE5JRmZBTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElDQVFESgpxZGI3Myt4cWFqclNuaHoxOTlWZGR3RUVvWGVSTi9jbkY0ZUdQODk0dURBSCtvcWYvVDNhUExZaWxHdnVoZElwCmUrUFk4Z2dsdUJRa3hzd1pDQjFzSFNGUFVHOFZPWmNQVU1SZGV1TVVqTUczcEhRT3J4N2VMV1hYRXNnblJ3MTcKcjIvei92L3VVVmovaW15Z0cwQWRkV0t2Y2ZEZ3AwcHNlUFRMY0xaRkdURU1nN3Y2RWswWFRLMXlEdlhzWmliUQpWcTdVMEE1SE5nNm40SzByNFBycTNQTTdCZWVpQnpkY21yaDR4MkIzcXkvWDY3SXF5K2pTMFZZS2NmVFkwQ25FClR1KzE5cjJlSGY0ZGM4VXIzbzJSamptQUJ5cHBHYVQ0RDdkZ0g0a0hkeDJoN2NmMWhTeVozU3lMang4VkZFdzIKbmhFVjcrUVBXM2g1RExDaXMwelcyY2pyRFhKblIxT3dpR3NqWmgyWUZlMytiUUNiQU5sV0F0dVNaZTg0ZkVlLwpJeHRqLzhBMlAvd0thaitWeGIrWFZKd3l0YzJJbUhYUTdMcjZ6MlMzcFJUTmcyREQ3V2d2WkZvVk5WWkllR0xaCmJDYkVjdmpPQkdDSU1DK0tyV0dMYlQzaTFlMUxpY2k5MWFxWGNIcDlyRVpTbE8va1BHZjVnWDZGSmNqNmpWbzcKUDZLQ2xCbUloVllITXVlb3JIN09VRmw4bWRzVmF5eE1COGR6bHI0OXlRUXpocWlmM3l3TEpRRXBDbENzYnEvZApKMkQ5M0JUQTh6NWN0bzRJNW9DdGZRMkdqbGtmRUpHODYzZ2NJVC8zaWV1M0FJLytMQVRGTzcrVFlWcVlZOFNJCndEUVZ4czF3T3BIWk9FZWtmTzRmS1cxMkJRK2YrSzltK2owSVNGelVDQT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"
              userSearch:
                baseDN: ou=Users,dc=odp,dc=com
                filter: (objectClass=inetOrgPerson)
                loginAttr: uid
                emailAttr: mail
                numericalIdAttr: uidNumber
                cnAttr: cn
              groupSearch:
                baseDN: ou=Groups,dc=odp,dc=com
                filter: (objectClass=posixgroup)
                nameAttr: cn
                linkGroupAttr: memberUid
                linkUserAttr: uid
