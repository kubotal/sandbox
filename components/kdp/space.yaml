
components:

  - name: secrets
    createNamespace: true
    vars:
      secrets: []
      #  - name:
      #    data:
      #      - key:
      #        value:
    modules:
      - name: main
        source: flux-system
        chart:
          path: ./charts/kdp-secrets/0.1.0
        values: |
          secrets:
            {{- toYaml .Vars.secrets | nindent 10 }}


  - name: pgadmin
    createNamespace: true
    vars:
      admin:
        user: # TBD
        password: # TBD
      ingressInfix: # TBD
    modules:
      - name: main
        source: flux-system
        chart:
          path: ./charts/pgadmin/0.1.0
        values: |
          {{- if dig "kyverno" "namespace" "" .Context }}
          kyverno:
            namespace: {{ .Context.kyverno.namespace }}
          {{- end }}
          storage:
            enabled: true
            class: {{ .Context.storageClass.workspace }}
            size: 500M
          ingress:
            clusterIssuer: {{ .Context.certificateIssuer.public }}
            host:  pgadmin.{{ .Vars.ingressInfix}}.{{ .Context.ingress.url }}
          admin:
            value:
              email: {{ .Vars.admin.user }}
              password: {{ .Vars.admin.password }}

  - name: hive-metastore
    createNamespace: true
    vars:
      s3access:
        url: # TBD
        accessKey:  # TBD. Leave blank if secret is created outside
        secretKey:  # TBD
    modules:
      - name: main
        source: flux-system
        config:
          timeout:  "5m"
        chart:
          path: ./charts/kdp-hive-metastore/0.1.0
        values: |
          # fullNameOverride: hive-metastore-main   # Was based on releaseName, which contains the namespace
          s3Secret:
            accessKey: {{ .Vars.s3access.accessKey }}
            secretKey: {{ .Vars.s3access.secretKey }}
          hive-metastore:
            s3:
              url: {{ .Vars.s3access.url }} 
              accessKey:
                secretName: kdp-hive-metastore-s3-secret
                propertyName: accessKey
              secretKey:
                secretName: kdp-hive-metastore-s3-secret
                propertyName: secretKey
            networkPolicies:
              enabled: {{ .Context.networkPoliciesSupport }}
          pgcluster:
            storage:
              storageClass: {{ .Context.storageClass.data }}

  - name: workspace
    createNamespace: true
    vars:
      namespace: # TBD
    modules:
      - name: main
        source: flux-system
        chart:
          path: ./charts/kdp-workspace/0.1.0
        values: |
          namespace: {{ .Vars.namespace }}
