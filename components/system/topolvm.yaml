
sources:
  - name: topoprep
    kind: OCIRepository
    template: ociRepository
    config:
      url: oci://quay.io/kubotal/charts/topoprep
      version: 0.1.0-snapshot

  - name: vgop
    kind: OCIRepository
    template: ociRepository
    config:
      url: oci://quay.io/kubotal/charts/vgop
      version: 0.1.0-snapshot

  - name: topolvm
    kind: HelmRepository
    template: helmRepository
    config:
      url: https://topolvm.github.io/topolvm


components:

  - name: topolvm
    modules:
      - name: vgop
        source: vgop
        values: |
          {{- if .Context.topolvm.onControlPlane }}
          tolerations:
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
              effect: NoSchedule
            - key: node-role.kubernetes.io/master
              operator: Exists
              effect: NoSchedule
          {{ end }}
          volumeGroups:
          {{- range .Context.topolvm.storageClasses }}
            - name: {{ default .name .volumeGroupName }}
              selectors:
              {{ toYaml .selectors | nindent 6 }}
          {{- end }}          
          
      - name: topoprep
        source: topoprep
        dependsOn:
          - vgop

      - name: main
        source: topolvm
        chart:
          name: topolvm
          version: 15.0.0
        values: |
          controller:
            replicaCount: {{ .Context.topolvm.controller.replicaCount }}
          lvmd:
            deviceClasses:
            {{- range .Context.topolvm.storageClasses }}
              - name: {{ default .name .deviceClassName }}
                volume-group: {{ default .name .volumeGroupName }}
                default: false
                spare-gb: {{ default 1 .spareGb }}
            {{ end }}
          storageClasses:
          {{- range .Context.topolvm.storageClasses }}
            - name: {{ .name }}
              storageClass:
                fsType: {{ default "xfs" .fsType }}
                reclaimPolicy: {{ default "Delete" .reclaimPolicy }}
                {{- with .annotations }}
                annotations:
                  {{- range $k, $v := . }}
                  {{ $k }}: "{{$v}}"
                  {{- end }}
                {{- end }} 
                isDefaultClass: {{ default "false" .isDefaultClass }}
                volumeBindingMode: {{ default "WaitForFirstConsumer" .volumeBindingMode }}
                allowVolumeExpansion: {{ default "true" .allowVolumeExpansion }}
                {{- with .mountOptions }}
                mountOptions:
                  {{- range . }}
                  - {{ . }}
                  {{- end }}
                {{- end }}
                additionalParameters:
                  "topolvm.io/device-class": "{{ default .name .deviceClassName }}"
          {{- end }}
        dependsOn:
          - topoprep



