
sources:

  - name: flux-system
    create: false
    kind: GitRepository

  - name: stakater
    kind: HelmRepository
    template: helmRepository
    config:
      url: https://stakater.github.io/stakater-charts

  - name: mittwald
    kind: HelmRepository
    template: helmRepository
    config:
      url: https://helm.mittwald.de

  - name: jetstack
    kind: HelmRepository
    template: helmRepository
    config:
      url: https://charts.jetstack.io

  - name: metallb
    kind: HelmRepository
    template: helmRepository
    config:
      url: https://metallb.github.io/metallb

  - name: ingress-nginx
    kind: HelmRepository
    template: helmRepository
    config:
      url: https://kubernetes.github.io/ingress-nginx


components:

  - name: replicator
    createNamespace: true
    modules:
      - name: main
        source: mittwald
        chart:
          name: kubernetes-replicator
          version: 2.9.2
        values:
          podSecurityContext:
            seccompProfile:
              type: RuntimeDefault
          securityContext:  # For container
            capabilities:
              drop:
                - ALL
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
          livenessProbe:
            initialDelaySeconds: 10 # Was 60
            #  periodSeconds: 10
            #  timeoutSeconds: 1
            #  failureThreshold: 3
            #  successThreshold: 1
          readinessProbe:
            initialDelaySeconds: 10 # Was 60
            #  periodSeconds: 10
            #  timeoutSeconds: 1
            #  failureThreshold: 3
            #  successThreshold: 1

  - name: secret-generator
    createNamespace: true
    modules:
      - name: main
        source: mittwald
        chart:
          name: kubernetes-secret-generator
          version: 3.4.0
        values:
          # Otherwise, we got secret-generator-secret-generator
          fullnameOverride: secret-generator
          podSecurityContext:
            fsGroup: 2000
            seccompProfile:
              type: RuntimeDefault  # ?
          securityContext:
            allowPrivilegeEscalation: false   # ?
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000

  - name: reloader
    createNamespace: true
    modules:
      - name: main
        config:
          timeout: 3m
        source: stakater
        chart:
          name: reloader
          version: 1.0.72
        values:
          reloader:
            deployment:
              securityContext:
                seccompProfile:
                  type: RuntimeDefault
              containerSecurityContext:
                capabilities:
                  drop:
                    - ALL
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true

  - name: cert-manager
    createNamespace: true
    vars:
      trustNamespace: cert-manager
    modules:
      - name: main
        source: jetstack
        chart:
          name: cert-manager
          version: v1.14.4
        values:
          installCRDs: true
      - name: trust
        source: jetstack
        template: helmRelease
        chart:
          name: trust-manager
          version: v0.9.2
        values: |
          app:
            trust:
              namespace: {{ .Vars.trustNamespace }}
          secretTargets:
            enabled: false
        dependsOn:
          - main
      - name: issuers
        source: flux-system
        chart:
          path: charts/cert-issuers/0.1.0
        config:
          install:
            remediation:
              retries: 10
        values: |
          {{ toYaml .Context.certIssuers }}
        dependsOn:
          - main
          - trust

  - name: metallb
    createNamespace: true
    modules:
      - name: main
        source: metallb
        chart:
          name: metallb
          version: 0.14.4
      - name: pool
        source: flux-system
        chart:
          path: ./charts/metallb-pool/0.1.0
        values: |
          ipRanges:
            - first: {{ resolveDNS (printf "first.pool.%s" .Context.cluster.domain) }}
              last: {{ resolveDNS (printf "last.pool.%s" .Context.cluster.domain) }}
        dependsOn:
          - main

  - name: ingress-nginx
    createNamespace: true
    vars:
      kubernetes:
        host: # TBD. ingress for api server.
    modules:
      - name: main
        source: ingress-nginx
        chart:
          name: ingress-nginx
          version: 4.10.0
        values: |
          controller:
            service:
              annotations:
                metallb.universe.tf/loadBalancerIPs: {{ resolveDNS .Context.ingress.url }}
                metallb.universe.tf/allow-shared-ip: "ingress"
            extraArgs:
              enable-ssl-passthrough: true
      - name: ext
        source: flux-system
        chart:
          path: ./charts/ingress-ext/0.1.0
        values: |
          kubernetes:
            enabled: {{ .Context.ingress.kubernetes.enabled }}
            host: kubernetes.{{ .Context.ingress.url }}
        dependsOn:
          - main
