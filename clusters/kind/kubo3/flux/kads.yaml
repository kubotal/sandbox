
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: OCIRepository
metadata:
  name: kad-controller
  namespace: flux-system
spec:
  interval: 1m
  layerSelector:
    mediaType: "application/vnd.cncf.helm.chart.content.v1.tar+gzip"
    operation: copy
  url: oci://quay.io/kubotal/charts/kad-controller
  ref:
    semver: "= 0.2.1-snapshot"


---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: kad-controller
  namespace: flux-system
spec:
  interval: 1m
  serviceAccountName: kustomize-controller
  targetNamespace: flux-system
  storageNamespace: flux-system
  releaseName: kad-controller
  timeout: 2m
  chartRef:
    kind: OCIRepository
    name: kad-controller
    namespace: flux-system
  values:
    config:
      primarySources:
        - name: flux-system
          namespace: flux-system
          kadFiles:
            - clusters/context.yaml
            - clusters/kind/context.yaml
            - clusters/kind/kubo3/context.yaml
            - clusters/kind/kubo3/deployments
            - components
            - parents
            - templates.yaml
      sweepPeriod: 2m # TODO: Set to 1h after setup
    logger:
      mode: dev
      level: info
    image:
      pullPolicy: Always

